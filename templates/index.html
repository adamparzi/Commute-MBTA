<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBTA Real-Time Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map {
            height: 400px;
            width: 50%;
        }
    </style>
</head>
<body>
    <h1 style="text-align:center">Commute MBTA</h1>

    <!-- Dropdown for selecting a line -->
    <label for="line-select">Select a Line:</label>
    <select id="line-select">
        <option value="Red">Red Line</option>
        <option value="Orange">Orange Line</option>
        <option value="Blue">Blue Line</option>
        <option value="Green-B">Green Line B</option>
        <option value="Green-C">Green Line C</option>
        <option value="Green-D">Green Line D</option>
        <option value="Green-E">Green Line E</option>
        <option value="Mattapan">Mattapan Line</option>
        <option value="Bus">Bus</option>
    </select>



    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
    <!-- these two scripts are simply libraries; they provide socket and map related methods.  -->
    <script>
        var map = L.map('map').setView([42.3601, -71.0589], 13);  // Initial map location (Boston)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        var markers = {};  // To keep track of markers on the map

        var socket = io();

        // Function to update the map based on the selected line
        function updateMap(line) {
            socket.emit('request_data', { line: line });  
            // Send selected line to the server; key: value pair
            // The first 'line' is just labeling it a line (key)
            // Second 'line' is passing it the original parameter which itself was passed by event listener (value)
        }

        // Event listener for dropdown change
        document.getElementById('line-select').addEventListener('change', function() {
            var selectedLine = this.value;
            updateMap(selectedLine);
        });
        // EXPLANATION:
        // HTML element = the user-selected MBTAline in the document
        // Event listener (event = 'change') triggers a function any time the MBTAline changes.
        // The function, defined as a parameter, passes the selected line to updateMap().
        // updateMap() emits the new MBTAline with the event as 'request_data' to flask backend,
        //     to make an API call there for the location data.
        
        // Receive data from the server and update the map
        socket.on('new_data', function(data) {
            // Remove existing markers
            for (var id in markers) {
                map.removeLayer(markers[id]);
            }
            markers = {};

            // Add new markers
            data.forEach(function(vehicle) {
                var lat = vehicle.attributes.latitude;
                var lon = vehicle.attributes.longitude;
                var marker = L.marker([lat, lon]).addTo(map);
                markers[vehicle.id] = marker;
            });
        });

        // Initialize with the default line
        updateMap(document.getElementById('line-select').value);
        // since there is no change event to trigger default on page open
    </script>
</body>
</html>
